<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="css-variable-editor.html">
<link rel="import" href="css-mixin-editor.html">
<!--
A visual css variavbles and mixins editor for Polymer web components.
It accepts data model generated by the `polymer-styles-analyzer` web component
and generates a form view for each element.

Call `generate()` function to create a `custom-styles` module definition for
Polymer application.


### Example
```
<polymer-styles-analyzer parsed-styles="{{parsedStyles}}"></polymer-styles-analyzer>
<polymer-styles-editor parsed-styles="{{parsedStyles}}"></polymer-styles-editor>
```

### Styling
`<polymer-styles-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--polymer-styles-editor` | Mixin applied to the element | `{}`
`--polymer-styles-editor-element-title` | Mixin applied to the elemnt name title | `{}`
`--polymer-styles-editor-section-title` | Mixin applied to the elemnt's section label | `{}`

@group UI Elements
@element polymer-styles-editor
@demo demo/index.html
-->
<dom-module id="polymer-styles-editor">
  <template>
    <style>
    :host {
      display: block;
      @apply --polymer-styles-editor;
    }

    h4 {
      @apply --arc-font-title;
      @apply --polymer-styles-editor-element-title;
    }

    h5 {
      @apply --arc-font-subhead;
      font-size: 15px;
      @apply --polymer-styles-editor-section-title;
    }
    </style>

    <template is="dom-repeat" items="{{parsedStyles}}">
      <template is="dom-if" if="[[item.hasStyles]]">
        <section class="element">
          <h4>[[item.name]]</h4>
          <template is="dom-if" if="[[item.hasVariables]]">
            <h5>Variables</h5>
            <template is="dom-repeat" items="{{item.variables}}">
              <css-variable-editor model="{{item}}" data-name$="[[item.name]]"></css-variable-editor>
            </template>
          </template>
          <template is="dom-if" if="[[item.hasMixins]]">
            <h5>Mixins</h5>
            <template is="dom-repeat" items="{{item.mixins}}">
              <css-mixin-editor model="{{item}}" data-name$="[[item.name]]"></css-mixin-editor>
            </template>
          </template>
        </section>
      </template>
    </template>
  </template>
  <script>
  Polymer({
    is: 'polymer-styles-editor',
    properties: {
      /**
       * List of variables and mixins data model as returned by the
       * `polymer-styles-analyzer` web component.
       */
      parsedStyles: Array,
      // List of updated variables and mixins.
      updatedStyles: Object
    },

    observers: ['_stylesChanged(parsedStyles.*)'],

    _stylesChanged: function(record) {
      if (!record || !record.path) {
        return;
      }
      if (this._cancaleStyleChangeOnEvent) {
        return;
      }
      var path = record.path;
      if (path.indexOf('.value') === -1) {
        return;
      }
      path = path.substr(0, path.lastIndexOf('.'));
      var model = this.get(path);
      if (model.value === model.defaultValue) {
        return;
      }
      var elementPathMatch = path.match(/parsedStyles.#\d+/);
      var itemModel = this.get(elementPathMatch[0]);
      var isVariable = path.indexOf('.variable') !== -1;
      this._updateModelStyles(itemModel.name, model, isVariable);
    },

    _updateModelStyles: function(moduleId, model, isVariable) {
      if (!this.updatedStyles) {
        this.updatedStyles = {};
      }
      if (!this.updatedStyles[moduleId]) {
        this.updatedStyles[moduleId] = {};
      }
      var listName = isVariable ? 'variables' : 'mixins';
      var userData = this.updatedStyles[moduleId];
      if (!userData[listName]) {
        userData[listName] = {};
      }
      if (!model.value && !userData[listName][model.name]) {
        return;
      }
      userData[listName][model.name] = model.value;
      this._applyUserStyles();
      this._updateChildrenValues(model.name, model.value);
    },

    _applyUserStyles: function() {
      var definitions = {};
      var styles = this.updatedStyles;
      Object.keys(styles).forEach(moduleId => {
        var vars = styles[moduleId].variables;
        var mix = styles[moduleId].mixins;
        if (vars) {
          definitions = Object.assign(definitions, vars);
        }
        if (mix) {
          definitions = Object.assign(definitions, mix);
        }
      });
      Polymer.updateStyles(definitions);
    },

    _updateChildrenValues: function(name, value) {
      var items = Polymer.dom(this.root).querySelectorAll('[data-name="' + name + '"]');
      if (items.length === 1) {
        return;
      }
      this._cancaleStyleChangeOnEvent = true;
      items.forEach(item => {
        if (item.value === value) {
          return;
        }
        item.value = value;
      });
      this._cancaleStyleChangeOnEvent = false;
    },
    /**
     * Generates `custom-style` definition for Polymer application.
     *
     * @return {String} Generated style definition.
     */
    generate: function() {
      var html = '<style is="custom-style">\n';
      html += ':root {\n';

      var styles = this.updatedStyles;
      Object.keys(styles).forEach(moduleId => {
        let vars = styles[moduleId].variables;
        let mix = styles[moduleId].mixins;
        let tmp = '';
        if (vars) {
          tmp += this._variablesToString(vars);
        }
        if (mix) {
          tmp += this._mixinsToString(mix);
        }
        if (tmp) {
          html += '\t/*' + moduleId + '*/\n';
          html += tmp;
        }
      });
      html += '}\n';
      html += '</style>';
      return html;
    },

    _variablesToString: function(variables) {
      var result = '';
      Object.keys(variables).forEach(varName => {
        if (!variables[varName]) {
          return;
        }
        result += '\t' + varName + ': ' + variables[varName] + ';\n';
      });
      return result;
    },

    _mixinsToString: function(mixins) {
      var result = '';
      Object.keys(mixins).forEach(name => {
        let value = mixins[name];
        if (!value) {
          return;
        }
        value = value.split('\n').join('\t\t\n');
        result += '\t' + name + ': {\n';
        result += '\t\t' + value + '\n';
        result += '\t};\n';
      });
      return result;
    }
  });
  </script>
</dom-module>
